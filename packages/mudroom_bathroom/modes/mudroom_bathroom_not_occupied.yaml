automation:
  - id: "mudroom_bathroom_not_occupied"
    initial_state: on
    alias: "Mudroom Bathroom Not Occupied"
    trigger:
      # Door is opened
      - platform: state
        entity_id: binary_sensor.mudroom_bathroom_door
        to: "on"
      # Door is opened for 5 mins
      - platform: state
        entity_id: binary_sensor.mudroom_bathroom_door
        to: "on"
        for:
          minutes: 5
      # Mudroom Bathroom lights are turned OFF
      - platform: state
        entity_id: light.mudroom_bathroom_main_lights
        to: "off"
      # Mudroom Bathroom lights are turned OFF for 5 mins
      - platform: state
        entity_id: light.mudroom_bathroom_main_lights
        to: "off"
        for:
          minutes: 5
    condition:
      # Mudroom Bathroom is already occupied
      - condition: state
        entity_id: input_boolean.mudroom_bathroom_occupied
        state: "on"
      - condition: or
        conditions:
          # Door is open AND lights are OFF
          - condition: and
            conditions:
              # Door open
              - condition: state
                entity_id: binary_sensor.mudroom_bathroom_door
                state: "on"
              # Lights off
              - condition: state
                entity_id: light.mudroom_bathroom_main_lights
                state: "off"
          # OR
          # Door is open for 5 mins OR lights are OFF for 5 mins
          - condition: or
            conditions:
              # Door closed for 5 mins
              - condition: state
                entity_id: binary_sensor.mudroom_bathroom_door
                state: "on"
                for:
                  minutes: 5
              # Lights off for 5 mins
              - condition: state
                entity_id: light.mudroom_bathroom_main_lights
                state: "off"
                for:
                  minutes: 5
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.mudroom_bathroom_occupied
